''' Script to calculate equilibrium MSD from a given trajectory (or trajectories) for
the nonuniform Icosahedron.'''

import argparse
import cPickle
import cProfile
import numpy as np
import os
import pstats
import StringIO
import sys
sys.path.append('..')

from quaternion_integrator.quaternion import Quaternion
import icosohedron_nonuniform as icn
from utils import MSDStatistics
from utils import calc_msd_data_from_trajectory

def calc_icosahedron_center(location, orientation):
  ''' Function to get icosahedron center.'''
  return location


if __name__ == '__main__':
  parser = argparse.ArgumentParser(description='Calculate rotation and '
                                   'translation MSD from a trajectory '
                                   'generated by icosohedron_nonuniform.py')
  parser.add_argument('--profile', dest='profile', type=bool, default=False,
                      help='True or False: Do we profile this run or not. '
                      'Defaults to false. Put --profile 1 to profile.')

  args=parser.parse_args()
  if args.profile:
    pr = cProfile.Profile()
    pr.enable()

  # List files here to process.  They must have the same timestep.
  trajectory_file_names = [
    'icosahedron-nonuniform-trajectory-dt-0.5-N-5000-testing-scheme-RFD.pkl']
  scheme = 'FIXMAN'
  dt = 0.1
  end = 1500.
  N = 2000


  ##########
  msd_runs = []
  for name in trajectory_file_names:
    data_file_name = os.path.join(tf.DATA_DIR, 'tetrahedron', name)
    with open(data_file_name) as f:
      trajectory_data = cPickle.load(f)
    # Check correct timestep.
    if trajectory_data['dt'] != dt:
      raise Exception('Timestep of data does not match specified timestep.')

    # Calculate MSD data (just an array of MSD at each time.)
    msd_data = calc_msd_data_from_trajectory(trajectory_data, calc_tetrahedron_com, dt, end)
    # append to calculate Mean and Std.
    msd_runs.append(msd_data)

  mean_msd = np.mean(np.array(msd_runs), axis=0)
  std_msd = np.std(np.array(msd_runs), axis=0)/np.sqrt(len(trajectory_file_names))
  time = np.arange(0, end, dt)

  params = {}
  for x in ['masses', 'KT', 'DEBYE_LENGTH', 'REPULSION_STRENGTH',
    'n_steps', 'dt', 'A', 'eta']:
    params[x] = trajectory_data[x]

  msd_statistics = MSDStatistics(params)
  msd_statistics.add_run(scheme, dt, [time, mean_msd, std_msd])

  # Save MSD data with pickle.
  msd_data_file_name = os.path.join(tf.DATA_DIR, 'tetrahedron', 
                                    'tetrahedron-msd-dt-%s-N-%s-end-%s-scheme-%s.pkl' %
                                    (dt, N, end, scheme))
  with open(msd_data_file_name, 'wb') as f:
    cPickle.dump(msd_statistics, f)

  
  if args.profile:
    pr.disable()
    s = StringIO.StringIO()
    sortby = 'cumulative'
    ps = pstats.Stats(pr, stream=s).sort_stats(sortby)
    ps.print_stats()
    print s.getvalue()  
